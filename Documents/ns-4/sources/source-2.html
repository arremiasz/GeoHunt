


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > GeohuntService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.geohunt.backend.Services</a>
</div>

<h1>Coverage Summary for Class: GeohuntService (com.geohunt.backend.Services)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">GeohuntService</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    90.9%
  </span>
  <span class="absValue">
    (10/11)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    35.7%
  </span>
  <span class="absValue">
    (10/28)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    68%
  </span>
  <span class="absValue">
    (85/125)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.geohunt.backend.Services;
&nbsp;
&nbsp;import com.fasterxml.jackson.databind.JsonNode;
&nbsp;import com.geohunt.backend.database.*;
&nbsp;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.http.HttpStatus;
&nbsp;import org.springframework.http.ResponseEntity;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;
&nbsp;import com.fasterxml.jackson.databind.ObjectMapper;
&nbsp;import java.net.URI;
&nbsp;import java.net.http.HttpClient;
&nbsp;import java.net.http.HttpRequest;
&nbsp;import java.net.http.HttpResponse;
&nbsp;
&nbsp;import java.time.LocalDate;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;import java.util.Optional;
&nbsp;import java.util.Random;
&nbsp;
&nbsp;@Service
<b class="fc">&nbsp;public class GeohuntService {</b>
&nbsp;
&nbsp;    @Autowired
&nbsp;    private ChallengesRepository challengesRepository;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private AccountService accountService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private SubmissionsRepository submissionsRepository;
&nbsp;
&nbsp;    public double haversine(double lat1, double lon1, double lat2, double lon2) {
<b class="fc">&nbsp;        double R = 3959; // miles</b>
<b class="fc">&nbsp;        double dLat = Math.toRadians(lat2 - lat1);</b>
<b class="fc">&nbsp;        double dLon = Math.toRadians(lon2 - lon1);</b>
<b class="fc">&nbsp;        double a = Math.sin(dLat / 2) * Math.sin(dLat / 2)</b>
<b class="fc">&nbsp;                + Math.cos(Math.toRadians(lat1)) * Math.cos(Math.toRadians(lat2))</b>
<b class="fc">&nbsp;                * Math.sin(dLon / 2) * Math.sin(dLon / 2);</b>
<b class="fc">&nbsp;        double c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));</b>
<b class="fc">&nbsp;        return R * c;</b>
&nbsp;    }
&nbsp;
&nbsp;    public List&lt;Challenges&gt; getPossibleChallenges(double lat, double lon, double rad) {
<b class="fc">&nbsp;        List&lt;Challenges&gt; all = challengesRepository.findAll();</b>
<b class="fc">&nbsp;        return new ArrayList&lt;&gt;(</b>
<b class="fc">&nbsp;                all.stream()</b>
<b class="fc">&nbsp;                        .filter(c -&gt; haversine(lat, lon, c.getLatitude(), c.getLongitude()) &lt;= rad)</b>
<b class="fc">&nbsp;                        .toList()</b>
&nbsp;        );
&nbsp;    }
&nbsp;
&nbsp;    public Challenges getChallenge(double lat, double lon, double rad) {
<b class="fc">&nbsp;        List&lt;Challenges&gt; possible = getPossibleChallenges(lat, lon, rad);</b>
&nbsp;
<b class="fc">&nbsp;        List&lt;Challenges&gt; generated = generateChallenges(lat, lon, rad, 3);</b>
<b class="fc">&nbsp;        challengesRepository.saveAll(generated);</b>
<b class="fc">&nbsp;        possible.addAll(generated);</b>
&nbsp;
<b class="fc">&nbsp;        Random random = new Random();</b>
<b class="fc">&nbsp;        Challenges r = possible.get(random.nextInt(possible.size()));</b>
<b class="fc">&nbsp;        return r;</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    public List&lt;Challenges&gt; generateChallenges(double lat, double lon, double rad, int count) {
<b class="fc">&nbsp;        List&lt;Challenges&gt; generated = new ArrayList&lt;&gt;();</b>
<b class="fc">&nbsp;        String apiKey = &quot;AIzaSyA4cGMdtzfM4Ub-1agmFLqKP5WLWLLwLLg&quot;;</b>
<b class="fc">&nbsp;        ObjectMapper mapper = new ObjectMapper();</b>
<b class="fc">&nbsp;        HttpClient client = HttpClient.newHttpClient();</b>
&nbsp;
&nbsp;
&nbsp;        try {
&nbsp;
<b class="fc">&nbsp;            int radiusMeters = (int) (rad * 1609.34);</b>
&nbsp;
<b class="fc">&nbsp;            String placesUrl = String.format(</b>
&nbsp;                    &quot;https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=%f,%f&amp;radius=%d,&amp;key=%s&quot;,
<b class="fc">&nbsp;                    lat, lon, radiusMeters, apiKey</b>
&nbsp;            );
&nbsp;
<b class="fc">&nbsp;            HttpRequest request = HttpRequest.newBuilder()</b>
<b class="fc">&nbsp;                    .uri(URI.create(placesUrl))</b>
<b class="fc">&nbsp;                    .GET()</b>
<b class="fc">&nbsp;                    .build();</b>
&nbsp;
<b class="fc">&nbsp;            HttpResponse&lt;String&gt; response = client.send(request, HttpResponse.BodyHandlers.ofString());</b>
<b class="fc">&nbsp;            JsonNode root = mapper.readTree(response.body());</b>
<b class="fc">&nbsp;            JsonNode results = root.get(&quot;results&quot;);</b>
&nbsp;
<b class="pc">&nbsp;            if (results == null || !results.isArray() || results.isEmpty()) {</b>
<b class="fc">&nbsp;                System.out.println(&quot;No landmarks found in the area, falling back to random generation.&quot;);</b>
<b class="fc">&nbsp;                return fallbackGenerate(lat, lon, rad, count);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            int added = 0;</b>
<b class="nc">&nbsp;            for (JsonNode place : results) {</b>
<b class="nc">&nbsp;                if (added &gt;= count) break;</b>
&nbsp;
<b class="nc">&nbsp;                JsonNode location = place.path(&quot;geometry&quot;).path(&quot;location&quot;);</b>
<b class="nc">&nbsp;                double newLat = location.path(&quot;lat&quot;).asDouble();</b>
<b class="nc">&nbsp;                double newLon = location.path(&quot;lng&quot;).asDouble();</b>
<b class="nc">&nbsp;                String name = place.path(&quot;name&quot;).asText(&quot;Unknown Landmark&quot;);</b>
&nbsp;
<b class="nc">&nbsp;                String streetviewUrl = String.format(</b>
&nbsp;                        &quot;https://maps.googleapis.com/maps/api/streetview?size=600x400&amp;location=%f,%f&amp;key=%s&quot;,
<b class="nc">&nbsp;                        newLat, newLon, apiKey</b>
&nbsp;                );
&nbsp;
<b class="nc">&nbsp;                if (challengesRepository.findByStreetviewurl(streetviewUrl).isPresent()) {</b>
&nbsp;
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                Challenges challenge = new Challenges();</b>
<b class="nc">&nbsp;                challenge.setLatitude(newLat);</b>
<b class="nc">&nbsp;                challenge.setLongitude(newLon);</b>
<b class="nc">&nbsp;                challenge.setStreetviewurl(streetviewUrl);</b>
<b class="nc">&nbsp;                challenge.setCreationdate(LocalDate.now());</b>
<b class="nc">&nbsp;                challengesRepository.save(challenge);</b>
&nbsp;
<b class="nc">&nbsp;                generated.add(challenge);</b>
<b class="nc">&nbsp;                added++;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            return generated;</b>
&nbsp;
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            e.printStackTrace();</b>
<b class="nc">&nbsp;            System.out.println(&quot;Error using Places API, falling back to random generation.&quot;);</b>
<b class="nc">&nbsp;            return fallbackGenerate(lat, lon, rad, count);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private double[] randomLocation(double lat, double lon, double radiusMiles) {
<b class="fc">&nbsp;        double radiusKm = radiusMiles * 1.60934;</b>
<b class="fc">&nbsp;        double radiusEarthKm = 6371.0;</b>
&nbsp;
<b class="fc">&nbsp;        double radiusRadians = radiusKm / radiusEarthKm;</b>
<b class="fc">&nbsp;        double u = Math.random();</b>
<b class="fc">&nbsp;        double v = Math.random();</b>
&nbsp;
<b class="fc">&nbsp;        double w = radiusRadians * Math.sqrt(u);</b>
<b class="fc">&nbsp;        double t = 2 * Math.PI * v;</b>
&nbsp;
<b class="fc">&nbsp;        double newLat = Math.asin(Math.sin(Math.toRadians(lat)) * Math.cos(w)</b>
<b class="fc">&nbsp;                + Math.cos(Math.toRadians(lat)) * Math.sin(w) * Math.cos(t));</b>
<b class="fc">&nbsp;        double newLon = Math.toRadians(lon) + Math.atan2(</b>
<b class="fc">&nbsp;                Math.sin(t) * Math.sin(w) * Math.cos(Math.toRadians(lat)),</b>
<b class="fc">&nbsp;                Math.cos(w) - Math.sin(Math.toRadians(lat)) * Math.sin(newLat)</b>
&nbsp;        );
&nbsp;
<b class="fc">&nbsp;        return new double[]{Math.toDegrees(newLat), Math.toDegrees(newLon)};</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    public List&lt;Challenges&gt; fallbackGenerate(double lat, double lon, double rad, int count) {
<b class="fc">&nbsp;        List&lt;Challenges&gt; generated = new ArrayList&lt;&gt;();</b>
<b class="fc">&nbsp;        String apiKey = &quot;AIzaSyA4cGMdtzfM4Ub-1agmFLqKP5WLWLLwLLg&quot;;</b>
<b class="fc">&nbsp;        for (int i = 0; i &lt; count; i++) {</b>
<b class="fc">&nbsp;            double[] coords = randomLocation(lat, lon, rad);</b>
<b class="fc">&nbsp;            double newLat = coords[0];</b>
<b class="fc">&nbsp;            double newLon = coords[1];</b>
&nbsp;
<b class="fc">&nbsp;            String streetviewUrl = String.format(</b>
&nbsp;                    &quot;https://maps.googleapis.com/maps/api/streetview?size=600x400&amp;location=%f,%f&amp;key=%s&quot;,
<b class="fc">&nbsp;                    newLat, newLon, apiKey</b>
&nbsp;            );
&nbsp;
<b class="fc">&nbsp;                Challenges challenge = new Challenges();</b>
<b class="fc">&nbsp;                challenge.setLatitude(newLat);</b>
<b class="fc">&nbsp;                challenge.setLongitude(newLon);</b>
<b class="fc">&nbsp;                challenge.setStreetviewurl(streetviewUrl);</b>
<b class="fc">&nbsp;                challenge.setCreationdate(LocalDate.now());</b>
<b class="fc">&nbsp;                challengesRepository.save(challenge);</b>
<b class="fc">&nbsp;                generated.add(challenge);</b>
&nbsp;
&nbsp;        }
<b class="fc">&nbsp;        return generated;</b>
&nbsp;    }
&nbsp;
&nbsp;    public ResponseEntity customChallenge(double lat, double lng, long uid, String url){
&nbsp;        try{
<b class="fc">&nbsp;            Challenges challenge = new Challenges();</b>
<b class="fc">&nbsp;            Account a = accountService.getAccountById(uid);</b>
<b class="fc">&nbsp;            challenge.setLatitude(lat);</b>
<b class="fc">&nbsp;            challenge.setLongitude(lng);</b>
<b class="fc">&nbsp;            challenge.setStreetviewurl(url);</b>
<b class="fc">&nbsp;            challenge.setCreationdate(LocalDate.now());</b>
<b class="fc">&nbsp;            challenge.setCreator(a);</b>
<b class="fc">&nbsp;            challengesRepository.save(challenge);</b>
<b class="fc">&nbsp;            return ResponseEntity.ok(challenge);</b>
&nbsp;        } catch (IllegalArgumentException e) {
<b class="nc">&nbsp;            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(&quot;User not found.&quot;);</b>
&nbsp;        }
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    public ResponseEntity getUsersChallenges(long id) {
&nbsp;        try{
<b class="fc">&nbsp;            List&lt;Challenges&gt; returnable = challengesRepository.getChallengesByCreator(accountService.getAccountById(id));</b>
<b class="fc">&nbsp;            return ResponseEntity.status(HttpStatus.OK).body(returnable);</b>
&nbsp;        } catch (IllegalArgumentException e) {
<b class="nc">&nbsp;            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(e.getMessage());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public ResponseEntity deleteUsersChallenges(long uid, long cid){
&nbsp;        Account user;
&nbsp;        try{
<b class="fc">&nbsp;            user = accountService.getAccountById(uid);</b>
&nbsp;        } catch (IllegalArgumentException e) {
<b class="nc">&nbsp;            return ResponseEntity.status(HttpStatus.NOT_FOUND).body(&quot;User not found.&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        List&lt;Challenges&gt; returnable = challengesRepository.getChallengesByCreator(user);</b>
<b class="fc">&nbsp;        submissionsRepository.deleteByChallenge_Id(cid);</b>
<b class="pc">&nbsp;        for(Challenges challenge : returnable){</b>
<b class="fc">&nbsp;            if(challenge.getId() == cid){</b>
<b class="fc">&nbsp;                challengesRepository.deleteById(challenge.getId());</b>
<b class="fc">&nbsp;                return ResponseEntity.status(HttpStatus.OK).build();</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return ResponseEntity.status(HttpStatus.NOT_FOUND).body(&quot;Challenge not found.&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    public ResponseEntity updateChallenge(long userId, long chalId, String image, double lng, double lat) {
&nbsp;        Account user;
&nbsp;        try{
<b class="nc">&nbsp;            user = accountService.getAccountById(userId);</b>
&nbsp;        } catch (IllegalArgumentException e) {
<b class="nc">&nbsp;            return ResponseEntity.status(HttpStatus.NOT_FOUND).body(&quot;User not found.&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        Optional&lt;Challenges&gt; challenge = challengesRepository.findById(chalId);</b>
<b class="nc">&nbsp;        if(!challenge.isPresent()){</b>
<b class="nc">&nbsp;            return ResponseEntity.status(HttpStatus.NOT_FOUND).body(&quot;Challenge not found.&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        if(userId != challenge.get().getCreator().getId()){</b>
<b class="nc">&nbsp;            return ResponseEntity.status(HttpStatus.NOT_FOUND).body(&quot;User does not own challenge.&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        challenge.get().setStreetviewurl(image);</b>
<b class="nc">&nbsp;        if(lat != -200){</b>
<b class="nc">&nbsp;            challenge.get().setLatitude(lat);</b>
&nbsp;        }
<b class="nc">&nbsp;        if(lng != -200){</b>
<b class="nc">&nbsp;            challenge.get().setLongitude(lng);</b>
&nbsp;        }
<b class="nc">&nbsp;        challengesRepository.save(challenge.get());</b>
<b class="nc">&nbsp;        return ResponseEntity.ok().build();</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-12-09 21:04</div>
</div>
</body>
</html>
